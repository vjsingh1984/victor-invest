= XBRL Tag Alias Mapping System
:toc: left
:toclevels: 3
:sectnums:
:icons: font
:source-highlighter: pygments

== Overview

The XBRL Tag Alias Mapping system provides *unified tag resolution* across different data sources to ensure robust financial data extraction regardless of company-specific XBRL tag variations.

[NOTE]
====
Built and validated using actual XBRL tag patterns from FAANG companies (Apple, Amazon, Meta, Alphabet, Netflix).
====

== Problem Statement

Different companies use different XBRL tags for the same financial concepts:

.Revenue Tag Variations Across FAANG Companies
[cols="1,3",options="header"]
|===
| Company | Revenue Tag Used

| Apple, Amazon, Meta, Alphabet
| `RevenueFromContractWithCustomerExcludingAssessedTax`

| Netflix
| `Revenues`
|===

[WARNING]
====
Without a unified mapping system, extraction code would need company-specific logic, leading to:

* *Fragile code*: Breaks when encountering new tag variations
* *Incomplete data*: Missing values when expected tags aren't present
* *Maintenance burden*: Every new company requires code updates
====

== Solution Architecture

[source,text]
----
┌─────────────────────────────────────────────────────────────────┐
│                        DATA SOURCES                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────┐ │
│  │ SEC CompanyFacts │  │  SEC Bulk DERA   │  │  Processed   │ │
│  │   API (JSON)     │  │  Tables (RDBMS)  │  │   Tables     │ │
│  │                  │  │                  │  │              │ │
│  │  CamelCase XBRL  │  │  CamelCase XBRL  │  │  snake_case  │ │
│  │  Tags            │  │  Tags            │  │  canonical   │ │
│  └──────────────────┘  └──────────────────┘  └──────────────┘ │
│                                                                 │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                   XBRLTagAliasMapper                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ TAG_ALIASES: Dict[str, List[str]]                        │  │
│  │                                                          │  │
│  │  'total_revenue' → ['RevenueFromContract...', 'Revenues'] │  │
│  │  'net_income'    → ['NetIncomeLoss', 'NetIncome']       │  │
│  │  'total_assets'  → ['Assets']                           │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ REVERSE_MAP: Dict[str, str] (auto-built)                │  │
│  │                                                          │  │
│  │  'Revenues'              → 'total_revenue'              │  │
│  │  'NetIncomeLoss'         → 'net_income'                 │  │
│  │  'Assets'                → 'total_assets'               │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ Core Methods:                                            │  │
│  │                                                          │  │
│  │  • get_xbrl_aliases(canonical) → [xbrl_tags]           │  │
│  │  • resolve_to_canonical(xbrl_tag) → canonical          │  │
│  │  • extract_value_with_fallbacks(data, canonical)       │  │
│  │  • normalize_xbrl_dict(xbrl_data) → canonical_dict     │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
└────────────────────────────┬────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────┐
│                   DOWNSTREAM AGENTS                             │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────┐  ┌──────────────────┐  ┌──────────────┐ │
│  │ Fundamental      │  │  Synthesis       │  │  PDF         │ │
│  │ Agent            │  │  Agent           │  │  Generator   │ │
│  │                  │  │                  │  │              │ │
│  │ Extract with     │  │ Canonical names  │  │ Consistent   │ │
│  │ fallbacks        │  │ only             │  │ field naming │ │
│  └──────────────────┘  └──────────────────┘  └──────────────┘ │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
----

== Tag Coverage Analysis

=== FAANG Companies Validation

.Companies Analyzed for Tag Variations
[cols="2,2,2,3",options="header"]
|===
| Company | CIK | Filings Analyzed | Data Source

| Apple (AAPL)
| 0000320193
| 2024-FY, 2025-Q1
| SEC Bulk Tables

| Amazon (AMZN)
| 0001018724
| 2024-FY, 2025-Q1
| SEC Bulk Tables

| Meta (META)
| 0001326801
| 2024-FY, 2025-Q1
| SEC Bulk Tables

| Alphabet (GOOGL)
| 0001652044
| 2024-FY, 2025-Q1
| SEC Bulk Tables

| Netflix (NFLX)
| 0001065280
| 2024-FY, 2025-Q1
| SEC Bulk Tables
|===

=== Critical Tag Variations Discovered

==== Revenue Tags

[source,text]
----
┌─────────────────────────────────────────────────────────────────┐
│                     REVENUE TAG VARIATIONS                      │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Canonical Name: total_revenue                                  │
│                                                                 │
│  Priority 1 (Most Common):                                      │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ RevenueFromContractWithCustomerExcludingAssessedTax      │  │
│  │                                                          │  │
│  │ Used by: AAPL, AMZN, META, GOOGL (4/5 companies)        │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  Priority 2 (Fallback):                                         │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ Revenues                                                 │  │
│  │                                                          │  │
│  │ Used by: NFLX (1/5 companies)                           │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  Priority 3 (Alternative):                                      │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ SalesRevenueNet                                          │  │
│  │                                                          │  │
│  │ Used by: Legacy companies                               │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
----

==== Cost of Revenue Tags

.Cost of Revenue Tag Variations
[cols="3,2,2",options="header"]
|===
| XBRL Tag | Companies Using | Canonical Name

| `CostOfRevenue`
| GOOGL, META, NFLX
| `cost_of_revenue`

| `CostOfGoodsAndServicesSold`
| AAPL
| `cost_of_revenue`

| `CostOfSales`
| Alternative
| `cost_of_revenue`
|===

==== Capital Expenditures Tags

[source,text]
----
┌─────────────────────────────────────────────────────────────────┐
│            CAPITAL EXPENDITURES TAG VARIATIONS                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Canonical: capital_expenditures                                │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ AAPL: PaymentsToAcquirePropertyPlantAndEquipment         │  │
│  │       (Standard cash flow tag)                           │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ AMZN: PaymentsToAcquireProductiveAssets                  │  │
│  │       (Amazon-specific variation)                        │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │ META: CapitalExpendituresIncurredButNotYetPaid           │  │
│  │       (Accrual basis accounting)                         │  │
│  └──────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
----

==== Accounts Payable Tags

.Accounts Payable Tag Variations
[cols="3,2,2",options="header"]
|===
| XBRL Tag | Companies Using | Canonical Name

| `AccountsPayableCurrent`
| AAPL, AMZN, GOOGL, NFLX
| `accounts_payable`

| `AccountsPayableTradeCurrent`
| META
| `accounts_payable`
|===

== Supported Metrics

=== Coverage Matrix

.Canonical Metrics Supported (50+ metrics)
[cols="1,4",options="header"]
|===
| Category | Metrics

| *Income Statement*
| `total_revenue`, `cost_of_revenue`, `gross_profit`, `operating_income`, `net_income`, `eps_basic`, `eps_diluted`, `research_and_development`, `selling_general_administrative`

| *Balance Sheet - Assets*
| `total_assets`, `current_assets`, `noncurrent_assets`, `cash_and_equivalents`, `cash_and_short_term_investments`, `accounts_receivable`, `inventory`, `property_plant_equipment`, `goodwill`, `intangible_assets`, `other_assets_current`, `other_assets_noncurrent`

| *Balance Sheet - Liabilities*
| `total_liabilities`, `current_liabilities`, `noncurrent_liabilities`, `accounts_payable`, `accrued_liabilities`, `deferred_revenue`, `long_term_debt`, `short_term_debt`, `total_debt`

| *Balance Sheet - Equity*
| `stockholders_equity`, `retained_earnings`, `common_stock`, `additional_paid_in_capital`, `treasury_stock`, `accumulated_other_comprehensive_income`

| *Cash Flow Statement*
| `operating_cash_flow`, `investing_cash_flow`, `financing_cash_flow`, `capital_expenditures`, `free_cash_flow`, `depreciation_amortization`, `stock_based_compensation`, `dividends_paid`, `share_repurchases`

| *Shares Outstanding*
| `shares_outstanding`, `shares_issued`, `weighted_average_shares_basic`, `weighted_average_shares_diluted`
|===

== Usage Examples

=== Basic Tag Resolution

[source,python]
----
from utils.xbrl_tag_aliases import get_tag_mapper

mapper = get_tag_mapper()

# Get all possible XBRL tags for a metric
revenue_tags = mapper.get_xbrl_aliases('total_revenue')
# Returns: ['RevenueFromContractWithCustomerExcludingAssessedTax',
#           'Revenues', 'SalesRevenueNet']

# Resolve XBRL tag to canonical name
canonical = mapper.resolve_to_canonical('Revenues')
# Returns: 'total_revenue'
----

=== Extraction with Automatic Fallback

[source,python]
----
from utils.xbrl_tag_aliases import get_tag_mapper

mapper = get_tag_mapper()

# AAPL data (uses long tag name)
aapl_data = {
    'RevenueFromContractWithCustomerExcludingAssessedTax': 394_328_000_000,
    'NetIncomeLoss': 99_803_000_000,
}

# NFLX data (uses short tag name)
nflx_data = {
    'Revenues': 39_000_966_000,
    'NetIncomeLoss': 8_711_631_000,
}

# Same extraction code works for both!
aapl_revenue = mapper.extract_value_with_fallbacks(aapl_data, 'total_revenue')
# Returns: 394_328_000_000 (matches first alias)

nflx_revenue = mapper.extract_value_with_fallbacks(nflx_data, 'total_revenue')
# Returns: 39_000_966_000 (falls back to second alias 'Revenues')
----

.Fallback Logic Flow
[source,text]
----
extract_value_with_fallbacks(data, 'total_revenue'):

  Alias Priority List:
  [1] RevenueFromContractWithCustomerExcludingAssessedTax
  [2] Revenues
  [3] SalesRevenueNet

  ┌─────────────────────────────────────────────┐
  │ Check Alias #1 in data?                     │
  │                                             │
  │  ✓ Found & Not None → Return value         │
  │  ✗ Missing or None  → Try next alias       │
  └──────────────────┬──────────────────────────┘
                     │
                     ▼
  ┌─────────────────────────────────────────────┐
  │ Check Alias #2 in data?                     │
  │                                             │
  │  ✓ Found & Not None → Return value         │
  │  ✗ Missing or None  → Try next alias       │
  └──────────────────┬──────────────────────────┘
                     │
                     ▼
  ┌─────────────────────────────────────────────┐
  │ Check Alias #3 in data?                     │
  │                                             │
  │  ✓ Found & Not None → Return value         │
  │  ✗ Missing or None  → Return default/None  │
  └─────────────────────────────────────────────┘
----

=== Bulk Dictionary Normalization

[source,python]
----
from utils.xbrl_tag_aliases import normalize_xbrl_dict

# Raw XBRL data from SEC API or bulk tables
xbrl_data = {
    'Revenues': 39_000_966_000,
    'NetIncomeLoss': 8_711_631_000,
    'Assets': 53_630_374_000,
    'Liabilities': 28_886_807_000,
}

# Convert to canonical snake_case dictionary
normalized = normalize_xbrl_dict(xbrl_data)

# Result:
# {
#     'total_revenue': 39_000_966_000,
#     'net_income': 8_711_631_000,
#     'total_assets': 53_630_374_000,
#     'total_liabilities': 28_886_807_000,
# }
----

=== Convenience Functions

[source,python]
----
from utils.xbrl_tag_aliases import (
    get_xbrl_aliases,
    resolve_to_canonical,
    extract_with_fallbacks,
    normalize_xbrl_dict,
)

# Quick access without instantiating mapper
aliases = get_xbrl_aliases('total_revenue')
canonical = resolve_to_canonical('Revenues')
value = extract_with_fallbacks(data, 'total_revenue')
normalized = normalize_xbrl_dict(xbrl_data)
----

== Integration Patterns

=== Before: Fragile Code ❌

[source,python]
----
# agents/fundamental_agent.py (OLD - DO NOT USE)
def extract_revenue(self, data: Dict) -> Optional[float]:
    """Extract revenue - breaks on Netflix!"""
    # Only checks one tag - fails for NFLX
    return data.get('RevenueFromContractWithCustomerExcludingAssessedTax')

# Result:
# ✓ Works for AAPL, AMZN, META, GOOGL
# ✗ Returns None for NFLX (uses 'Revenues' tag)
----

=== After: Robust Code ✅

[source,python]
----
# agents/fundamental_agent.py (NEW - RECOMMENDED)
from utils.xbrl_tag_aliases import get_tag_mapper

def extract_financials(self, xbrl_data: Dict) -> Dict[str, float]:
    """Extract financial metrics using unified tag mapper."""
    mapper = get_tag_mapper()

    # Automatically tries all known aliases in priority order
    return {
        'total_revenue': mapper.extract_value_with_fallbacks(
            xbrl_data, 'total_revenue'
        ),
        'net_income': mapper.extract_value_with_fallbacks(
            xbrl_data, 'net_income'
        ),
        'total_assets': mapper.extract_value_with_fallbacks(
            xbrl_data, 'total_assets'
        ),
        'current_liabilities': mapper.extract_value_with_fallbacks(
            xbrl_data, 'current_liabilities'
        ),
    }

    # OR use normalize_xbrl_dict for bulk conversion:
    # return mapper.normalize_xbrl_dict(xbrl_data)

# Result:
# ✓ Works for ALL FAANG companies
# ✓ Automatic fallback for company-specific tags
# ✓ No breaking changes when new tag variants appear
----

=== SEC CompanyFacts API Integration

[source,python]
----
# utils/sec_companyfacts_extractor.py
from utils.xbrl_tag_aliases import normalize_xbrl_dict

def extract_company_facts(cik: str) -> Dict[str, Any]:
    """Extract company facts from SEC API with tag normalization."""
    # Fetch from SEC API (returns camelCase XBRL tags)
    raw_data = fetch_sec_api(cik)

    # Extract XBRL facts from nested structure
    xbrl_facts = parse_xbrl_facts(raw_data)

    # CRITICAL: Normalize to canonical snake_case IMMEDIATELY
    normalized_data = normalize_xbrl_dict(xbrl_facts, include_unmatched=True)

    # Now safe to save to database/cache with consistent naming
    save_to_database(normalized_data)
    return normalized_data
----

=== Bulk Table DAO Integration

[source,python]
----
# dao/sec_bulk_dao.py
from utils.xbrl_tag_aliases import get_tag_mapper

def fetch_financial_metrics(
    cik: str,
    fiscal_year: int,
    fiscal_period: str
) -> Dict[str, float]:
    """Fetch financial metrics from SEC bulk tables."""
    mapper = get_tag_mapper()

    # Query bulk table (returns XBRL tags)
    query = """
        SELECT tag, value
        FROM sec_num_data n
        JOIN sec_sub_data s ON n.adsh = s.adsh
        WHERE s.cik = %s
          AND EXTRACT(YEAR FROM n.ddate) = %s
          AND n.qtrs = %s
    """

    results = execute_query(query, [cik, fiscal_year, get_qtrs(fiscal_period)])

    # Convert to dict: {xbrl_tag: value}
    xbrl_data = {row['tag']: row['value'] for row in results}

    # Normalize to canonical names with fallbacks
    return mapper.normalize_xbrl_dict(xbrl_data)
----

== Testing

=== Test Coverage

.Test Suite Statistics
[cols="2,1,3",options="header"]
|===
| Test Category | Tests | Coverage

| Tag Resolution
| 6
| All canonical names → XBRL tags

| Reverse Mapping
| 3
| All XBRL tags → canonical names

| Fallback Logic
| 4
| Priority-ordered alias matching

| Real-world Cases
| 5
| Actual FAANG company data patterns

| Edge Cases
| 4
| Empty data, None values, zero values

| Convenience Functions
| 5
| Singleton pattern, quick access

| Integration Tests
| 9
| Cross-company compatibility

| *Total*
| *36*
| *100% pass rate*
|===

=== Running Tests

[source,bash]
----
# Run all tag alias tests
pytest tests/utils/test_xbrl_tag_aliases.py -v

# Run with coverage
pytest tests/utils/test_xbrl_tag_aliases.py --cov=utils.xbrl_tag_aliases

# Run specific test class
pytest tests/utils/test_xbrl_tag_aliases.py::TestFAANGRealWorldCases -v
----

=== Test Output Example

[source,text]
----
tests/utils/test_xbrl_tag_aliases.py::TestXBRLTagAliasMapper::
  test_get_xbrl_aliases_revenue PASSED                    [  2%]
  test_resolve_to_canonical_revenue PASSED                [ 11%]
  test_extract_value_with_fallbacks_first_match PASSED    [ 19%]
  test_normalize_xbrl_dict_simple PASSED                  [ 30%]

tests/utils/test_xbrl_tag_aliases.py::TestFAANGRealWorldCases::
  test_apple_quarterly_2025_q1 PASSED                     [ 77%]
  test_netflix_annual_2024 PASSED                         [ 80%]
  test_amazon_mixed_tags PASSED                           [ 83%]
  test_meta_quarterly_2025_q1 PASSED                      [ 86%]
  test_alphabet_annual_2024 PASSED                        [ 88%]

============================== 36 passed in 0.03s ======================
----

== Performance Characteristics

.Performance Metrics
[cols="2,1,3",options="header"]
|===
| Operation | Complexity | Notes

| Initialization
| O(n)
| n ≈ 150 mappings, happens once at startup

| Reverse Lookup
| O(1)
| Hash table lookup (XBRL tag → canonical)

| Forward Lookup
| O(1)
| Dict lookup (canonical → aliases list)

| Extract with Fallbacks
| O(k)
| k = number of aliases per metric (typically 1-4)

| Bulk Normalization
| O(m × k)
| m = XBRL tags in data, k = aliases per tag

| *Memory Usage*
| *~50KB*
| All mappings in memory (negligible)
|===

[TIP]
====
The mapper uses a singleton pattern, so initialization cost is paid only once per application lifecycle.
====

== Best Practices

=== ✅ DO

[cols="1,4",frame=none,grid=rows]
|===
| ✓ | *Use canonical names everywhere* +
All internal code should use `total_revenue`, not `Revenues`

| ✓ | *Extract at the boundary* +
Convert XBRL tags → canonical names as early as possible (in extractors/DAOs)

| ✓ | *Test with real data* +
Validate mappings with actual company filings, not synthetic data

| ✓ | *Log fallback usage* +
Log which alias was used for debugging (built into `extract_value_with_fallbacks`)

| ✓ | *Update tests when adding mappings* +
Add test cases when adding new metrics or aliases
|===

=== ❌ DON'T

[cols="1,4",frame=none,grid=rows]
|===
| ✗ | *Don't hardcode XBRL tags* +
Use the mapper instead of direct dictionary access

| ✗ | *Don't assume all companies use same tags* +
Always use fallback logic via the mapper

| ✗ | *Don't manually skip None values* +
The mapper automatically skips None and tries next alias

| ✗ | *Don't mix camelCase and snake_case* +
Standardize on snake_case for internal use, mapper handles conversion

| ✗ | *Don't ignore priority order* +
Most common tags should be listed first in alias lists
|===

== Extending the System

=== Adding New Metrics

[source,python]
----
# utils/xbrl_tag_aliases.py

TAG_ALIASES = {
    # ... existing mappings ...

    'new_metric_name': [
        'PrimaryXBRLTag',       # Most common tag (highest priority)
        'AlternativeXBRLTag',   # Fallback tag
        'LegacyXBRLTag',        # Legacy tag (lowest priority)
    ],
}
----

.Extension Workflow
[source,text]
----
┌──────────────────────────────────────────────────────────────┐
│ Step 1: Identify New Metric                                 │
│                                                              │
│  • Find metric in company filings                           │
│  • Check multiple companies for tag variations              │
│  • Document in comments                                     │
└────────────────────────┬─────────────────────────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────────────────────┐
│ Step 2: Add to TAG_ALIASES                                  │
│                                                              │
│  • Choose canonical snake_case name                         │
│  • List XBRL tags in priority order (most common first)     │
│  • Include comments on which companies use each tag         │
└────────────────────────┬─────────────────────────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────────────────────┐
│ Step 3: Write Tests                                         │
│                                                              │
│  • Test get_xbrl_aliases() returns correct list             │
│  • Test resolve_to_canonical() for each alias               │
│  • Test extract_value_with_fallbacks() with real data       │
└────────────────────────┬─────────────────────────────────────┘
                         │
                         ▼
┌──────────────────────────────────────────────────────────────┐
│ Step 4: Validate with Real Company Data                     │
│                                                              │
│  • Query SEC bulk tables for tag usage                      │
│  • Test with FAANG companies                                │
│  • Document coverage in this AsciiDoc                       │
└──────────────────────────────────────────────────────────────┘
----

=== Testing New Mappings

[source,python]
----
# tests/utils/test_xbrl_tag_aliases.py

def test_new_metric():
    """Test new metric mapping."""
    mapper = XBRLTagAliasMapper()

    # Test aliases list
    aliases = mapper.get_xbrl_aliases('new_metric_name')
    assert 'PrimaryXBRLTag' in aliases

    # Test reverse mapping
    canonical = mapper.resolve_to_canonical('PrimaryXBRLTag')
    assert canonical == 'new_metric_name'

    # Test extraction
    data = {'PrimaryXBRLTag': 100_000}
    value = mapper.extract_value_with_fallbacks(data, 'new_metric_name')
    assert value == 100_000
----

== Migration Guide

=== For Existing Code

.Migration Steps
[source,text]
----
BEFORE (Fragile):                    AFTER (Robust):
─────────────────                    ───────────────

revenue = data.get(                  from utils.xbrl_tag_aliases import ↴
  'RevenueFromContract...'             get_tag_mapper
)
                                     mapper = get_tag_mapper()
                                     revenue = mapper.extract_value_with_↴
                                       fallbacks(data, 'total_revenue')

───────────────────────────────────────────────────────────────────

✗ Breaks on NFLX                     ✓ Works on all FAANG companies
✗ No fallback logic                  ✓ Automatic fallback
✗ Company-specific code              ✓ Unified extraction
----

.Step-by-Step Migration
[cols="1,3,3",options="header"]
|===
| Step | Action | Example

| 1
| Identify hardcoded XBRL tag access
| `revenue = data.get('RevenueFrom...')`

| 2
| Import tag mapper
| `from utils.xbrl_tag_aliases import get_tag_mapper`

| 3
| Replace with mapper extraction
| `revenue = mapper.extract_value_with_fallbacks(data, 'total_revenue')`

| 4
| Update tests
| Add test cases for NFLX tag variation

| 5
| Validate
| Run tests, check logs for fallback usage
|===

== Troubleshooting

=== Common Issues

.Issue: Extraction Returns None
[cols="1,3",options="header"]
|===
| Cause | Solution

| XBRL tag not in alias list
| Check actual tags in data: `print(list(xbrl_data.keys()))` +
Add missing alias to `TAG_ALIASES` mapping

| Tag name has typo
| Verify exact tag spelling (case-sensitive)

| Value is actually None in source
| Check source data quality, not a mapping issue
|===

.Issue: Wrong Canonical Name Resolved
[cols="1,3",options="header"]
|===
| Cause | Solution

| XBRL tag maps to multiple canonical names
| Check logs for warning: `"Duplicate XBRL tag..."` +
Remove duplicate from lower-priority metric +
First occurrence in `TAG_ALIASES` wins
|===

.Issue: Different Companies Return Different Values
[cols="1,3",options="header"]
|===
| Cause | Solution

| Companies use different accounting methods
| This is expected (not a mapping issue) +
Use `utils/data_normalizer.py` for precision +
Document company-specific quirks
|===

== API Reference

=== XBRLTagAliasMapper Class

[source,python]
----
class XBRLTagAliasMapper:
    """Maps canonical financial metrics to XBRL tag variations."""

    def get_xbrl_aliases(self, canonical_name: str) -> List[str]:
        """Get all XBRL tag aliases for a canonical metric name."""

    def resolve_to_canonical(self, xbrl_tag: str) -> Optional[str]:
        """Resolve an XBRL tag to its canonical snake_case name."""

    def extract_value_with_fallbacks(
        self,
        data: Dict[str, Any],
        canonical_name: str,
        default: Any = None
    ) -> Any:
        """Extract value trying all XBRL tag aliases in priority order."""

    def normalize_xbrl_dict(
        self,
        xbrl_data: Dict[str, Any],
        include_unmatched: bool = False
    ) -> Dict[str, Any]:
        """Convert XBRL tag dictionary to canonical snake_case dictionary."""

    def get_all_canonical_names(self) -> List[str]:
        """Get list of all canonical metric names."""

    def get_coverage_stats(self, xbrl_data: Dict[str, Any]) -> Dict[str, Any]:
        """Analyze coverage of canonical metrics in provided XBRL data."""
----

=== Convenience Functions

[source,python]
----
def get_tag_mapper() -> XBRLTagAliasMapper:
    """Get singleton instance of XBRLTagAliasMapper."""

def get_xbrl_aliases(canonical_name: str) -> List[str]:
    """Get XBRL tag aliases for a canonical metric name."""

def resolve_to_canonical(xbrl_tag: str) -> Optional[str]:
    """Resolve XBRL tag to canonical name."""

def extract_with_fallbacks(
    data: Dict[str, Any],
    canonical_name: str,
    default: Any = None
) -> Any:
    """Extract value from data trying all XBRL tag aliases."""

def normalize_xbrl_dict(
    xbrl_data: Dict[str, Any],
    include_unmatched: bool = False
) -> Dict[str, Any]:
    """Convert XBRL dict to canonical snake_case dict."""
----

== Future Enhancements

.Roadmap
[cols="1,3,2",options="header"]
|===
| Priority | Enhancement | Status

| High
| Auto-discovery of new tag variations by scanning filings
| Planned

| Medium
| Confidence scoring to track most commonly used aliases
| Planned

| Medium
| Company-specific tag profiles to optimize lookup order
| Planned

| Low
| XBRL taxonomy integration mapping to US GAAP concepts
| Research

| Low
| Validation rules to flag suspicious values per metric
| Research
|===

== References

.External Resources
[cols="2,3",options="header"]
|===
| Resource | URL

| SEC EDGAR
| https://www.sec.gov/edgar

| XBRL US GAAP Taxonomy
| https://www.xbrl.org/us-gaap-taxonomy

| SEC Bulk Data
| https://www.sec.gov/dera/data/financial-statement-data-sets

| Project Documentation
| `/.claude/CLAUDE.md`
|===

== Version History

.Release Notes
[cols="1,2,4",options="header"]
|===
| Version | Date | Changes

| 1.0.0
| 2025-11-03
| Initial implementation based on FAANG analysis +
• 50+ canonical metrics +
• 150+ XBRL tag aliases +
• Comprehensive test suite (36 tests) +
• Validated against 5 FAANG companies (10 filings)
|===

'''

[NOTE]
====
*Document Metadata*

* *Module*: `utils/xbrl_tag_aliases.py`
* *Tests*: `tests/utils/test_xbrl_tag_aliases.py`
* *Author*: InvestiGator Development Team
* *Last Updated*: {docdate}
====
