// InvestiGator - Architecture Documentation
// Copyright (c) 2025 Vijaykumar Singh
// Licensed under the Apache License, Version 2.0

= InvestiGator Architecture
:doctype: book
:toc: left
:toclevels: 4
:sectanchors:
:sectlinks:
:sectnums:
:source-highlighter: highlight.js
:icons: font
:reproducible:

[.lead]
Comprehensive architectural documentation for InvestiGator, an AI-powered investment research platform built on clean design patterns, efficient resource management, and multi-layer caching.

== Executive Summary

InvestiGator is a sophisticated *AI-powered investment analysis system* that orchestrates multiple specialized agents working in concert to provide comprehensive financial analysis.

*Key Characteristics:*

* *Agent-based architecture* with specialized agents (SEC, Technical, Fundamental, Synthesis)
* *Multi-layer caching* (File/Parquet + RDBMS) with priority-based retrieval
* *VRAM-aware resource management* for GPU-constrained LLM operations
* *Event-driven inter-agent communication* via event bus
* *Async-first design* for high concurrency and responsiveness

== High-Level Data Flow

[source,text]
----
User/CLI
   ↓
AgentOrchestrator (dependency graph, parallel execution)
   ↓
Level 1 Agents (parallel):
   - SEC Agent (filings, facts extraction)
   - Technical Agent (OHLCV, 80+ indicators)
   - Fundamental Agent (ratios, valuation, forecasts)
   - Market Context Agents (sector/ETF macro)
   ↓
Cache Layer (file/parquet/RDBMS, multi-priority)
   ↓
Level 2 Synthesis Agent (merges, weights, thesis)
   ↓
Results (JSON, optional PDF report)
----

== Component Architecture

=== Agent System

**Base Framework:** `agents/base.py::InvestmentAgent`

* *Lifecycle:* `pre_process()` → cache check → `process()` → `post_process()`
* *Normalization:* Automatic snake_case conversion in `post_process()` (Phase 1)
* *Task Model:* `AgentTask` → `AgentResult` with status tracking
* *Error Handling:* Retry with exponential backoff, timeout handling

**Specialized Agents:**

* `FundamentalAnalysisAgent` - Financial ratios, valuation, SEC data
* `TechnicalAnalysisAgent` - OHLCV indicators, pattern recognition
* `SECAnalysisAgent` - SEC filings extraction
* `SynthesisAgent` - Multi-agent aggregation, investment thesis
* `ETFMarketContextAgent` - Sector/ETF overlays

**Orchestration:** `agents/orchestrator.py`

* DAG-based dependency resolution
* Parallel Level 1 execution via `asyncio.gather()`
* Level 2 (synthesis) waits for Level 1 completion
* Priority queue for task scheduling

=== Cache System

**Multi-Layer Architecture:** (utils/cache/)

* *File Cache* (priority=10): gzipped JSON, fastest retrieval
* *Parquet Cache* (priority=10): Time-series OHLCV data
* *RDBMS Cache* (priority=5): PostgreSQL, durable storage

**Cache Manager:** `utils/cache/cache_manager.py`

* Priority-based retrieval (highest first)
* Automatic promotion from lower to higher priority
* TTL enforcement via background cleanup (Phase 4)
* Comprehensive metrics tracking

**Cache Types & TTL:**

* `LLM_RESPONSE`: 6 hours
* `TECHNICAL_DATA`: 7 days
* `COMPANY_FACTS`: 90 days
* `SEC_RESPONSE`: 6 hours
* `SUBMISSION_DATA`: 90 days
* `QUARTERLY_METRICS`: 24 hours

**Fiscal Period-Aware Caching (Phase 2):**

* Cache keys include `fiscal_period` field
* Prevents Q1/Q2/Q3/Q4 overwrites
* Filenames: `companyfacts_0000320193_2025-Q4.json.gz`

=== LLM Integration

**VRAM-Aware Semaphore:** `core/llm_semaphore.py`

* Real VRAM monitoring via Ollama `/api/ps` endpoint
* Dynamic per-task VRAM calculation
* Model reuse optimization
* Intelligent queueing when VRAM insufficient

**Resource-Aware Pool:** `core/resource_aware_pool.py`

* Multi-server load balancing
* Pessimistic reservation system
* Health monitoring and failover

=== Data Normalization (Phase 1)

**Implementation:** `utils/data_normalizer.py::DataNormalizer`

* Automatic snake_case conversion for all agent outputs
* Judicious rounding (prices: 2 decimals, large numbers: whole)
* Data quality assessment with completeness scoring
* Integrated into agent lifecycle (`post_process()`)

**Normalization Points:**

. *Agent outputs:* Automatic in `InvestmentAgent.post_process()`
. *SEC extraction:* Convert to snake_case at source
. *Synthesis:* Defensive normalization of all inputs
. *Cache storage:* All cached data uses snake_case keys

== Implementation Status

See link:PROGRESS.adoc[Implementation Progress] for current status.

*Quick Summary:*

* ✅ Phase 1-4 Complete (65% progress)
* ✅ All critical gaps resolved
* ⏳ Phases 5-6 remaining (documentation + validation)

---

*Last Updated:* 2025-11-02 +
*Version:* 2.0.0 (Post-Implementation) +
*License:* Apache 2.0