// InvestiGator - AI Investment Research Assistant
// Copyright (c) 2025 Vijaykumar Singh
// Licensed under the Apache License, Version 2.0
// See LICENSE file for details

= ğŸŠ InvestiGator - AI Investment Research Assistant
:doctype: book
:toc: left
:toclevels: 3
:sectanchors:
:sectlinks:
:sectnums:
:source-highlighter: highlight.js
:icons: font
:imagesdir: images
:reproducible:

[source,text]
----
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                              â•‘
â•‘ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•‘
â•‘ â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•šâ•â•â–ˆâ–ˆâ•”â•â•â•â•‘
â•‘    â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘   â•‘
â•‘    â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â•  â•šâ•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘   â•‘
â•‘    â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘   â•‘
â•‘    â•šâ•â•   â•šâ•â•  â•šâ•â•â•  â•šâ•â•â•â•  â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â•   â•šâ•â•   â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•  â•šâ•â•   â•‘
â•‘                                                                              â•‘
â•‘            ğŸŠ  Institutional-grade investment research on your Mac.         â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
----

[.lead]
InvestiGator unifies SEC fundamentals, technical indicators, and LLM synthesis to deliver privacy-first equity research with explainable outputs and repeatable workflows.

== ğŸ“Œ Quick Facts

* *Primary entry point:* `./investigator_v2.sh` â†’ `cli_orchestrator.py`
* *Core runtime:* Python 3.11+, async agent framework, Ollama-hosted LLMs
* *Target platform:* macOS 12+ on Apple Silicon (Metal acceleration enabled)
* *Data sources:* SEC EDGAR APIs, local market data snapshot (PostgreSQL/Parquet)
* *Caching:* Multi-layer (File/Parquet/RDBMS) with deterministic prompts
* *Packaged namespace:* `src/investigator/` provides domain/application/infrastructure/interfaces layers while legacy modules in `agents/`, `core/`, and `utils/` remain during migration

== ğŸ§­ Architectural Overview

[source,text]
----
                                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                 â”‚   CLI Orchestrator â”‚
                                 â”‚(cli_orchestrator.pyâ”‚
                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                           â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                           â”‚         â”‚          â”‚                           â”‚
â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”â”Œâ”€â”€â”€â–¼â”€â”€â”€â”â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚ SEC     â”‚                 â”‚ Technicalâ”‚â”‚Fundamentalâ”‚â”‚ Market/ETFâ”‚           â”‚Synthesisâ”‚
â”‚ Agent   â”‚                 â”‚ Agent    â”‚â”‚ Agent     â”‚â”‚ Context   â”‚           â”‚ Agent   â”‚
â”‚ (sec)   â”‚                 â”‚ (tech)   â”‚â”‚ (fund)    â”‚â”‚ Agents    â”‚           â”‚ (synth) â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜â””â”€â”€â”€â”¬â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚                           â”‚         â”‚          â”‚                           â”‚
     â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
     â”‚         â”‚          Agent Orchestrator (`core/`)                   â”‚         â”‚
     â”‚         â”‚  â€¢ Task scheduling & dependency graph                   â”‚         â”‚
     â”‚         â”‚  â€¢ Resource-aware LLM pool + semaphore                  â”‚         â”‚
     â”‚         â”‚  â€¢ Metrics, retries, progress signalling                â”‚         â”‚
     â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
     â”‚                                      â”‚                                      â”‚
     â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  Cache + Persistence Layer (`utils/`)    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚  â€¢ File/Parquet caches                   â”‚
                       â”‚  â€¢ RDBMS (Postgres/SQLite)               â”‚
                       â”‚  â€¢ Prompt/response registries            â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
----

=== Component Responsibilities

[cols="2,5",options="header"]
|===
| Component | Notes

| `src/investigator/`
| Installable package namespace (domain models, application orchestration, infrastructure adapters, shared utilities, interfaces). Source of truth for new modules (`application/orchestrator.py`, `cli.py`).

| `core/`
| Legacy orchestration primitives (LLM semaphore, resource-aware pool, metrics, job lifecycle) kept for backward compatibility while migration to `src/investigator/` completes.

| `agents/`
| Specialized async agents (SEC fundamentals, technical indicators, fundamentals, synthesis, ETF context) based on `InvestmentAgent`.

| `api/` & `cli_orchestrator.py`
| External interfaces exposing orchestration services to shell scripts, APIs, and tests.

| `utils/`
| Shared infrastructure: cache manager, database access, market data fetchers, ticker mapping, prompt optimization, logging helpers.

| `patterns/`
| Reusable prompt templates, formatting helpers, pattern matchers for LLM outputs.

| `tests/`
| Mirrored module structure, fixtures in `tests/fixtures/`, integration harnesses via CLI orchestrator.
|===

== ğŸ—‚ï¸ Repository Map

[source,text]
----
investigator/
â”œâ”€ src/investigator/   # Installable package (domain/, application/, infrastructure/, interfaces/, shared/)
â”œâ”€ agents/              # Agent implementations (sec, tech, fund, synth, market context)
â”œâ”€ api/                 # HTTP interface stubs & adapters
â”œâ”€ core/                # Orchestrator, scheduling, resource pool, metrics
â”œâ”€ utils/               # Cache, DB helpers, data fetchers, prompt optimizers
â”œâ”€ patterns/            # Prompt fragments, synthesis helpers, formatting utilities
â”œâ”€ tests/               # Unit + integration suites mirror runtime layout
â”œâ”€ data/                # On-disk caches (SEC, LLM, technical parquet)
â”œâ”€ archive/             # Git-ignored cold storage (historic logs, metrics, reports)
â”œâ”€ artifacts/           # Optional workspace for generated outputs during dev
â”œâ”€ diagrams/            # Architecture visuals consumed by README
â”œâ”€ investigator_v2.sh   # Preferred entrypoint; bootstraps Python orchestrator
â””â”€ cli_orchestrator.py  # Command routing for agentic pipeline
----

== ğŸ”„ Data & Control Flow

[source,text]
----
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  tasks   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  async jobs  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CLI / API   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Agent Orchestratorâ”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ Agent Workers â”‚
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                           â”‚                          results
      â”‚                  cache lookups / writes               â”‚
      â”‚                           â–¼                          â”‚
      â”‚                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
      â”‚                 â”‚ CacheManager      â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                 â”‚ â€¢ File (LLM JSON) â”‚
      â”‚                 â”‚ â€¢ Parquet (OHLCV) â”‚
      â”‚                 â”‚ â€¢ RDBMS snapshots â”‚
      â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚                          â”‚
      â–¼                          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚ Result Synth  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
----

*Markets & fundamentals* arrive through `utils.market_data_fetcher` and `utils.sec_companyfacts_extractor`.
*LLM* requests are funneled via `core.resource_aware_pool` with GPU-aware scheduling.
*Outputs* are persisted under `results/` with task metadata for downstream automation.

== ğŸš€ Getting Started

.Create an isolated environment
[source,bash]
----
python3 -m venv venv
source venv/bin/activate
pip install -r requirements-dev.txt
----

.Configure runtime
* Copy `config.json.sample` â†’ `config.json`, set a valid SEC user agent, and adjust Ollama endpoints (`config.yaml`).
* Confirm local market-data database credentials (`utils/db.py`) or place CSV fallback data under `data/`.

.Smoke test
[source,bash]
----
./investigator_v2.sh --test-system
----

== ğŸ“ˆ Running Analyses

[cols="2,4",options="header"]
|===
| Goal | Command
| Single symbol comprehensive | `./investigator_v2.sh --symbol AAPL`
| Standard-depth run | `./investigator_v2.sh --symbol MSFT --mode standard`
| Batch from CLI | `python cli_orchestrator.py batch AAPL MSFT NVDA --mode comprehensive`
| Peer comparison | `python cli_orchestrator.py compare AAPL MSFT GOOGL --output comparison.json`
| Regenerate using cached artifacts | `python cli_orchestrator.py rerun-task <TASK_ID>`
|=== 

Generated artifacts land in `results/<SYMBOL_TIMESTAMP>.json` alongside cached prompts and charts under `data/`.

== ğŸ”§ Development Guidelines

* *Code style:* PEP 8, 4-space indent, Google-style docstrings, functions <120 LOC.
* *Tooling:* `black .`, `isort .`, `mypy patterns/ utils/`, `ruff .` (optional) before commits.
* *Imports:* stdlib â†’ third-party â†’ local; pytest files named `test_<target>.py`.
* *Configuration:* Extend existing abstractions (`config.py`, `config.yaml`) instead of new ad-hoc knobs.
* *Caching:* Prefer `CacheManager` APIs; specify cache type enums for parity across handlers.
* *Observability:* Use `structlog`-style context (symbol/task ids) for new log lines.

== ğŸ§ª Testing & Quality

[source,bash]
----
pytest tests/ -v                               # core unit + integration
pytest tests/ --cov=patterns --cov=utils \
       --cov-report=html                       # coverage + HTML report in htmlcov/
./investigator_v2.sh --test-system             # orchestrated smoke test
./investigator_v2.sh --symbol TSLA --mode standard --dry-run  # CLI dry-run validation
----

*Fixtures* live in `tests/fixtures/` and mirror market/SEC data structures.
Tag integration-heavy suites with `@pytest.mark.integration`.
Mock SEC and Ollama dependencies in unit tests (see `tests/utils/test_cache.py` for patterns).

== ğŸ—„ï¸ Cache & Persistence Layer

* `utils/cache/cache_manager.py` â€” routing, TTL validation, promotion across handlers.
* `utils/cache/file_cache_handler.py` â€” gzipped JSON for prompts & LLM outputs (stores `response` + `thinking` payloads).
* `utils/cache/parquet_cache_handler.py` â€” parquet or pickle fallback for OHLCV data (handles DataFrame metadata).
* `utils/cache/rdbms_cache_handler.py` â€” durable Postgres/SQLite table for LLM responses and synthesis artifacts.

When writing new artifacts, supply:

[source,python]
----
cache_manager.set(
    CacheType.LLM_RESPONSE,
    {'symbol': symbol, 'llm_type': 'fundamental_growth_analysis'},
    llm_response_payload,
)
----

The manager automatically skips lower-priority handlers when a higher layer already owns the key.

== ğŸ§  Agent Reference

[cols="2,3,5",options="header"]
|===
| Agent | Location | Responsibilities

| SEC Agent | `agents/sec_agent.py` | Retrieves SEC facts, performs enrichment, caches summarized filings, primes fundamental agent context.
| Technical Agent | `agents/technical_agent.py` | Loads OHLCV data, computes 80+ indicators, pattern recognition via Qwen-based reasoning.
| Fundamental Agent | `agents/fundamental_agent.py` | Calculates ratios, market cap, data quality scores, valuation, forecasts.
| Market Context Agent | `agents/etf_market_context_agent.py` | ETF-anchored macro overlays, sector breadth, liquidity regimes.
| Synthesis Agent | `agents/synthesis_agent.py` | Merges upstream analyses, applies weighting heuristics, produces investment thesis & recommendations.
|===

Each agent inherits shared health checks, capability registration, and caching hooks from `agents/base.py`.

== ğŸ› ï¸ Operational Playbook

* *Resource awareness:* `core.resource_aware_pool` dynamically loads models (Llama/Qwen/DeepSeek) respecting GPU VRAM checks in `core.llm_semaphore`.
* *Retry semantics:* Failed agent tasks bubble up with detailed error codes; orchestrator retries idempotent operations before marking degraded.
* *Metrics:* `metrics/` captures execution spans and cache hit ratios; integrate with Prometheus/OpenTelemetry if available.
* *Logging:* Structured INFO-level logs track cache state (`Cache HIT/MISS`), market-data sufficiency, and LLM allocations.

== ğŸ“ Data & Assets

* `data/sec_cache/` â€” SEC facts, parsed filings, LLM prompt cache.
* `data/llm_cache/` â€” zipped JSON per symbol & `llm_type`.
* `data/technical_cache/` â€” parquet/pickle OHLCV snapshots grouped by timeframe.
* `results/` â€” active task outputs; move long-lived artifacts to `archive/results/` to keep diffs clean.
* `metrics/` â€” JSON snapshots emitted by `utils.monitoring.MetricsCollector`, prune with `make clean` or `clean-all`.
* `archive/` â€” git-ignored cold storage for historical logs, metrics, and reports.
* `artifacts/` â€” optional workspace for temporary charts or comparisons during development.
* `diagrams/` & `images/` â€” architecture/flow diagrams referenced by this README.

== ğŸ§¹ Repository Hygiene

* `make clean` removes bytecode, coverage artifacts, and other transient build outputs.
* `make clean-all` additionally purges cached data (`data/*_cache/`) and staging folders under `artifacts/`.
* Move long-running experiment logs or result snapshots into `archive/` once reviewed to keep the workspace and PR diffs lean.

== ğŸ§© Contribution Workflow

1. Fork or branch from `main`.
2. Ensure CI green locally (`pytest`, `black`, `isort`, `mypy`).
3. Use Conventional Commit prefixes (`feat:`, `fix:`, `docs:`, â€¦).
4. Reference related issues and maintain release notes in your fork (the upstream repository tracks history via git).
5. Provide result snapshots (`results/*.json`) or logs demonstrating changes where relevant.

== ğŸ“š Glossary

* *Analysis Mode* â€” `standard`, `comprehensive`, `quarterly` (affects workload & prompt set).
* *Cache Type* â€” Enum in `utils/cache/cache_types.py` representing storage strategy.
* *Thinking Trace* â€” Reasoning token stream returned by reasoning LLMs; persisted for transparency.
* *Task ID* â€” `<SYMBOL>_<epoch>` identifier tracked throughout orchestrator logs and result payloads.

== ğŸ¤ License

Apache 2.0 â€” see `LICENSE` and `NOTICE` for details.
