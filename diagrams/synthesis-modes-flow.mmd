graph TB
    %% Synthesis Mode Architecture Flow
    classDef synthesisClass fill:#e1f5fe,stroke:#0277bd,stroke-width:2px
    classDef cacheClass fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px
    classDef templateClass fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px
    classDef outputClass fill:#fff3e0,stroke:#ef6c00,stroke-width:2px
    classDef dataClass fill:#fce4ec,stroke:#c2185b,stroke-width:2px

    %% Entry Point
    CLI["`ðŸŽ¯ **CLI Entry**
    --synthesis-mode comprehensive
    --synthesis-mode quarterly`"]:::synthesisClass
    
    %% Main Synthesizer
    SYN["`ðŸ¤– **Synthesizer**
    Mode Selection Engine
    â€¢ generate_recommendation()
    â€¢ _extract_sec_comprehensive_data()
    â€¢ _extract_technical_indicators()
    â€¢ _create_recommendation_from_llm_data()`"]:::synthesisClass
    
    %% Mode Decision
    MODE{"`ðŸ”€ **Mode Switch**
    synthesis_mode?`"}:::synthesisClass
    
    %% Templates
    COMP_TMPL["`ðŸ“Š **Comprehensive Template**
    investment_synthesis_comprehensive.j2
    
    ðŸš€ **60% Faster Processing**
    â€¢ Direct LLM response extraction
    â€¢ Cached SEC comprehensive data
    â€¢ Cached technical indicators
    â€¢ Optimized JSON parsing`"]:::templateClass
    
    QUART_TMPL["`ðŸ“‹ **Quarterly Template**
    investment_synthesis_quarterly_mode.j2
    
    âš¡ **25% Faster Processing**
    â€¢ Quarter-by-quarter analysis
    â€¢ Trend progression tracking
    â€¢ Incremental data building
    â€¢ Temporal pattern recognition`"]:::templateClass
    
    PEER_TMPL["`ðŸ¢ **Peer Template**
    investment_synthesis_peer.j2
    
    ðŸŽ¯ **Peer-Relative Analysis**
    â€¢ Industry comparisons
    â€¢ Relative valuations
    â€¢ Sector positioning
    â€¢ Competitive analysis`"]:::templateClass
    
    %% Data Sources
    SEC_DATA["`ðŸ“Š **SEC Comprehensive**
    Cached LLM Response
    
    ðŸ§  **Thinking Extraction:**
    â€¢ analysis_summary
    â€¢ investment_thesis
    â€¢ quarterly_analyses.detail
    
    ðŸ“ˆ **Scores:**
    â€¢ business_quality_score: 9.1
    â€¢ fundamental_score: 8.2
    â€¢ growth_score: 7.5`"]:::dataClass
    
    TECH_DATA["`ðŸ”§ **Technical Analysis**
    File Cache (response_technical_indicators.txt)
    
    ðŸ§  **Thinking Extraction:**
    â€¢ thinking (detailed reasoning)
    â€¢ momentum_signals[]
    â€¢ risk_factors[]
    
    ðŸ“ˆ **Scores:**
    â€¢ technical_score: 5.5 (FIXED!)
    â€¢ support_levels: [193.46, 194.43]
    â€¢ resistance_levels: [213.94, 214.23]`"]:::dataClass
    
    %% Cache System
    CACHE["`ðŸ’¾ **Cache System**
    Multi-Level Storage
    
    ðŸ—ƒï¸ **File Cache:**
    â€¢ response_technical_indicators.txt
    â€¢ File fallback mechanism
    
    ðŸ’¿ **Database Cache:**
    â€¢ PostgreSQL JSONB
    â€¢ llm_type differentiation
    
    ðŸ”‘ **Cache Keys:**
    â€¢ synthesis_comprehensive
    â€¢ synthesis_quarterly`"]:::cacheClass
    
    %% Score Processing
    SCORES["`ðŸ“Š **Score Consolidation**
    Duplicate Removal & Extraction
    
    âœ… **Fixed Scoring:**
    â€¢ fundamental_score (not financial_health)
    â€¢ growth_score (not growth_prospects)
    â€¢ technical_score: 5.5 (was 0.0)
    
    ðŸŽ¯ **Weighted Overall:**
    â€¢ Fundamental: 8.2/10 (60% weight)
    â€¢ Technical: 5.5/10 (40% weight)
    â€¢ **Overall: 7.1/10** (was 4.7/10)`"]:::outputClass
    
    %% PDF Generation
    PDF["`ðŸ“„ **Enhanced PDF Report**
    Visual Components & Thinking
    
    ðŸ§  **Thinking Sections:**
    â€¢ SEC Fundamental Analysis Thinking
    â€¢ Technical Analysis Thinking
    â€¢ Synthesis Analysis Reasoning
    
    ðŸ“Š **Visual Components:**
    â€¢ ScoreCard flowables
    â€¢ RecommendationBadge components
    â€¢ Technical summary tables
    â€¢ Support/resistance displays`"]:::outputClass
    
    %% Flow Connections
    CLI --> SYN
    SYN --> MODE
    
    MODE -->|comprehensive| COMP_TMPL
    MODE -->|quarterly| QUART_TMPL
    MODE -->|peer| PEER_TMPL
    
    %% Data extraction flows
    COMP_TMPL --> SEC_DATA
    COMP_TMPL --> TECH_DATA
    QUART_TMPL --> SEC_DATA
    QUART_TMPL --> TECH_DATA
    
    %% Cache interactions
    SEC_DATA --> CACHE
    TECH_DATA --> CACHE
    
    %% Processing flows
    SEC_DATA --> SCORES
    TECH_DATA --> SCORES
    SCORES --> PDF
    
    %% Thinking extraction
    CACHE -.->|thinking extraction| PDF
    
    %% Performance annotations
    COMP_TMPL -.->|"60% faster"| SCORES
    QUART_TMPL -.->|"25% faster"| SCORES
    TECH_DATA -.->|"technical_score: 5.5"| SCORES
    SCORES -.->|"overall: 7.1/10"| PDF