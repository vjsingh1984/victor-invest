flowchart TD
    START([ğŸ¯ Cache Operation Request]) --> CONFIG_CHECK{âš™ï¸ Check Cache Config}
    
    CONFIG_CHECK -->|"storage: []"| NO_CACHE[âŒ Skip Cache<br/>Return None]
    CONFIG_CHECK -->|"storage: ['disk']"| DISK_ONLY[ğŸ’¾ Disk Only Mode]
    CONFIG_CHECK -->|"storage: ['rdbms']"| DB_ONLY[ğŸ—„ï¸ Database Only Mode]
    CONFIG_CHECK -->|"storage: ['disk','rdbms']"| BOTH_STORAGE[ğŸ”„ Multi-Storage Mode]
    
    subgraph FORCE_CHECK["ğŸ”„ Force Refresh Checks"]
        CHECK_GLOBAL{ğŸŒ Global Force Refresh?}
        CHECK_SYMBOL{ğŸ¯ Symbol-Specific<br/>Force Refresh?}
        CHECK_TTL{â° TTL Override?}
    end
    
    subgraph DISK_FLOW["ğŸ’¾ Disk Cache Operations"]
        DISK_READ[ğŸ“– Read from Disk]
        DISK_HIT{âœ… Cache Hit?}
        DISK_WRITE[ğŸ’¾ Write to Disk]
        DISK_COMPRESS[ğŸ—œï¸ gzip Compression<br/>Level 9]
        DISK_STATS[ğŸ“Š Update Disk Stats]
    end
    
    subgraph DB_FLOW["ğŸ—„ï¸ Database Cache Operations"]
        DB_READ[ğŸ“Š Read from Database]
        DB_HIT{âœ… Cache Hit?}
        DB_WRITE[ğŸ—„ï¸ Write to Database]
        DB_COMPRESS[ğŸ“¦ JSONB Compression]
        DB_STATS[ğŸ“ˆ Update DB Stats]
    end
    
    subgraph PRIORITY_FLOW["ğŸ† Priority Resolution"]
        PRIORITY_READ[ğŸ“‹ Priority Read Order<br/>Disk to Database]
        CACHE_HIT_CHECK{ğŸ¯ Cache Hit?}
        PROMOTE[â¬†ï¸ Promote to Higher Priority<br/>Database to Disk]
        FETCH_FRESH[ğŸ”„ Fetch Fresh Data]
    end
    
    subgraph HANDLER_ROUTING["ğŸ¯ Handler Routing"]
        TYPE_CHECK{ğŸ“‹ Check Cache Type}
        FILE_HANDLER[ğŸ“ FileCacheHandler<br/>SEC, LLM, Facts, Metrics]
        PARQUET_HANDLER[ğŸ“Š ParquetHandler<br/>Technical, Submissions]
        RDBMS_HANDLER[ğŸ—„ï¸ RDBMSHandler<br/>All Types when enabled]
    end
    
    DISK_ONLY --> FORCE_CHECK
    DB_ONLY --> FORCE_CHECK
    BOTH_STORAGE --> FORCE_CHECK
    
    FORCE_CHECK --> CHECK_GLOBAL
    CHECK_GLOBAL -->|Yes| FETCH_FRESH
    CHECK_GLOBAL -->|No| CHECK_SYMBOL
    CHECK_SYMBOL -->|Yes| FETCH_FRESH
    CHECK_SYMBOL -->|No| CHECK_TTL
    CHECK_TTL -->|Expired| FETCH_FRESH
    CHECK_TTL -->|Valid| TYPE_CHECK
    
    TYPE_CHECK --> FILE_HANDLER
    TYPE_CHECK --> PARQUET_HANDLER
    TYPE_CHECK --> RDBMS_HANDLER
    
    FILE_HANDLER --> PRIORITY_FLOW
    PARQUET_HANDLER --> DISK_FLOW
    RDBMS_HANDLER --> DB_FLOW
    
    PRIORITY_READ --> DISK_READ
    DISK_READ --> DISK_HIT
    DISK_HIT -->|Hit| CACHE_HIT_CHECK
    DISK_HIT -->|Miss| DB_READ
    
    DB_READ --> DB_HIT
    DB_HIT -->|Hit| CACHE_HIT_CHECK
    DB_HIT -->|Miss| FETCH_FRESH
    
    CACHE_HIT_CHECK -->|From Disk| RETURN_DISK[âœ… Return Data from Disk]
    CACHE_HIT_CHECK -->|From Database| PROMOTE
    PROMOTE --> DISK_WRITE
    PROMOTE --> RETURN_DB[âœ… Return Data from Database]
    
    FETCH_FRESH --> WRITE_ALL[ğŸ“ Write to All Enabled Storages]
    WRITE_ALL --> DISK_WRITE
    WRITE_ALL --> DB_WRITE
    
    DISK_WRITE --> DISK_COMPRESS
    DISK_COMPRESS --> DISK_STATS
    DB_WRITE --> DB_COMPRESS
    DB_COMPRESS --> DB_STATS
    
    DISK_STATS --> SUCCESS[âœ… Operation Complete]
    DB_STATS --> SUCCESS
    RETURN_DISK --> SUCCESS
    RETURN_DB --> SUCCESS
    NO_CACHE --> SUCCESS
    
    %% Styling
    classDef start fill:#e8f5e8,stroke:#4caf50,stroke-width:3px
    classDef decision fill:#fff2cc,stroke:#d6b656,stroke-width:2px
    classDef process fill:#d5e8d4,stroke:#82b366,stroke-width:2px
    classDef storage fill:#dae8fc,stroke:#6c8ebf,stroke-width:2px
    classDef success fill:#e1d5e7,stroke:#9673a6,stroke-width:2px
    classDef handler fill:#f8cecc,stroke:#b85450,stroke-width:2px
    
    class START start
    class CONFIG_CHECK,CHECK_GLOBAL,CHECK_SYMBOL,CHECK_TTL,DISK_HIT,DB_HIT,CACHE_HIT_CHECK,TYPE_CHECK decision
    class DISK_READ,DB_READ,PRIORITY_READ,FETCH_FRESH,PROMOTE,WRITE_ALL process
    class DISK_WRITE,DB_WRITE,DISK_COMPRESS,DB_COMPRESS,DISK_STATS,DB_STATS storage
    class SUCCESS,RETURN_DISK,RETURN_DB,NO_CACHE success
    class FILE_HANDLER,PARQUET_HANDLER,RDBMS_HANDLER handler