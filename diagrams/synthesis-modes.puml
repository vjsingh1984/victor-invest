@startuml synthesis-modes
!define RECTANGLE class

title InvestiGator v2.2 - Synthesis Mode Architecture

skinparam backgroundColor #f8f9fa
skinparam classBorderColor #2c3e50
skinparam classBackgroundColor #ecf0f1

package "Synthesis Engine" {
    RECTANGLE Synthesizer {
        + synthesis_mode: str
        + --synthesis-mode comprehensive
        + --synthesis-mode quarterly
        --
        + generate_recommendation()
        + _extract_sec_comprehensive_data()
        + _extract_technical_indicators()
        + _create_recommendation_from_llm_data()
    }
    
    package "Templates" {
        RECTANGLE ComprehensiveTemplate {
            investment_synthesis_comprehensive.j2
            --
            ðŸ“Š SEC Comprehensive Data
            ðŸ“ˆ Technical Indicators
            ðŸŽ¯ Direct Extraction (60% faster)
        }
        
        RECTANGLE QuarterlyTemplate {
            investment_synthesis_quarterly_mode.j2
            --
            ðŸ“‹ Quarter-by-Quarter Analysis
            ðŸ“Š Trend Analysis
            ðŸ”„ Progressive Processing (25% faster)
        }
        
        RECTANGLE PeerTemplate {
            investment_synthesis_peer.j2
            --
            ðŸ¢ Peer Group Comparisons
            ðŸ“Š Relative Valuations
            ðŸŽ¯ Industry Positioning
        }
    }
}

package "Data Sources" {
    RECTANGLE SECComprehensive {
        SEC Comprehensive Analysis
        --
        ðŸ“Š analysis_summary
        ðŸ’¡ investment_thesis
        ðŸ“ˆ quarterly_analyses.detail
        ðŸŽ¯ business_quality_score
        ðŸ’° financial_health_score
    }
    
    RECTANGLE TechnicalAnalysis {
        Technical Analysis Cache
        --
        ðŸ§  thinking (reasoning process)
        ðŸ“Š technical_score: 5.5
        ðŸ“ˆ momentum_signals[]
        âš ï¸ risk_factors[]
        ðŸŽ¯ support/resistance levels
    }
}

package "Output Generation" {
    RECTANGLE PDFReportGenerator {
        Enhanced PDF Reports
        --
        ðŸ§  SEC Fundamental Thinking
        ðŸ”§ Technical Analysis Thinking
        ðŸŽ¯ Synthesis Analysis Reasoning
        ðŸ“Š Visual Scorecards
        ðŸ“ˆ Technical Summary Tables
    }
    
    RECTANGLE ScoreComponents {
        Score Extraction & Display
        --
        ðŸ“Š Fundamental: 8.2/10
        ðŸ”§ Technical: 5.5/10 (fixed!)
        ðŸŽ¯ Overall: 7.1/10
        --
        âœ… growth_score (not growth_prospects)
        âœ… fundamental_score (not financial_health)
    }
}

package "Cache System" {
    RECTANGLE LLMCache {
        Multi-Level Cache
        --
        ðŸ—ƒï¸ File Cache (response_technical_indicators.txt)
        ðŸ’¾ Database Cache (PostgreSQL)
        ðŸ”„ Cache Key Differentiation
        ðŸ“ llm_type: synthesis_comprehensive
        ðŸ“ llm_type: synthesis_quarterly
    }
}

' Relationships
Synthesizer --> ComprehensiveTemplate : comprehensive mode
Synthesizer --> QuarterlyTemplate : quarterly mode
Synthesizer --> PeerTemplate : peer analysis

Synthesizer --> SECComprehensive : extract data
Synthesizer --> TechnicalAnalysis : extract indicators

ComprehensiveTemplate --> SECComprehensive : direct extraction
ComprehensiveTemplate --> TechnicalAnalysis : cached responses

Synthesizer --> PDFReportGenerator : generate report
PDFReportGenerator --> ScoreComponents : display scores

PDFReportGenerator --> LLMCache : thinking extraction
LLMCache --> SECComprehensive : comprehensive data
LLMCache --> TechnicalAnalysis : file fallback

note right of ComprehensiveTemplate
  **60% Faster Processing**
  - Extracts from cached LLM responses
  - Avoids re-processing raw data
  - Uses structured JSON outputs
end note

note right of QuarterlyTemplate
  **25% Faster Processing**
  - Quarter-by-quarter analysis
  - Trend-based insights
  - Progressive data building
end note

note right of TechnicalAnalysis
  **Fixed Technical Score**
  - Handles file headers correctly
  - Extracts technical_score: 5.5
  - Parses momentum_signals
  - File fallback in PDF generator
end note

note right of PDFReportGenerator
  **Enhanced Thinking Sections**
  - SEC: analysis_summary + investment_thesis
  - Technical: thinking + signals + risks
  - Synthesis: methodology + reasoning
  - Visual components & scorecards
end note

@enduml